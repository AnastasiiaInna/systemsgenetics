---
title: "DeconCell"
author: "RaÃºl Aguirre-Gamboa and Niek de Klein"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


## Introduction 
DeconCell is an r package containing models for predicting the proportions of circulating immune cell subpopulations using expression data whole blood. Models were built using elastic net bye training in 95 samples from healthy dutch individulas with FACS quantification of 73 circulating cell subpopulations. 
For aditional details on methods and results please go our [manuscript](link to be updated). 

## Pre-processing example data
Let's load and pre-process our example data. These are 5 samples with > ~40k genes quantified. These are gene quantifications, we need to approximate our data to a normal-like distribution and account for library sized. In order to do these we use the `dCell.expProcessing` function. This function will perform a TMM normalization (as described in the [edgeR](http://bioconductor.org/packages/release/bioc/html/edgeR.html)package) a log2(counts+1) and finally each gene is scaled. 
```{r}
library(devtools)
#install_github("raguirreg/DeconCell")
library(DeconCell)
library(edgeR)

data("count.table")
dCell.exp <- dCell.expProcessing(count.table, trim = TRUE)
```

## Prediction of cell propotions

```{r}
data("dCell.models")
prediction <- dCell.predict(dCell.exp, dCell.models, res.type = "median")
head(prediction$dCell.prediction)
head(prediction$Evaluation)
```

## Correlation coeficient between of predicted and measured values
```{r}
data("cell.proportions")
library(reshape2)
library(ggplot2)
data("dCell.names")
pData <- data.frame(PearsonCor= diag(cor(cell.proportions, prediction$dCell.prediction)), 
                    CTs = dCell.names[colnames(cell.proportions), "finalName"], 
                    Subpop = dCell.names[colnames(cell.proportions), "broadSubpopulations"])
ggplot(pData, aes(y=PearsonCor , x= CTs, fill=Subpop))+
  geom_bar(stat="identity", alpha=0.8)+
  geom_hline(yintercept = 0.5, alpha=0.5, color="red")+
  coord_flip()+
  scale_fill_brewer(palette = "Dark2")+
  theme_bw()
  
```

